'use strict';Object.defineProperty(exports,'__esModule',{value:true});var _requestPromiseNative=require('request-promise-native');var _requestPromiseNative2=_interopRequireDefault(_requestPromiseNative);var _crypto=require('crypto');var _crypto2=_interopRequireDefault(_crypto);var _config=require('./config');var _util=require('./util');function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _asyncToGenerator(fn){return function(){var gen=fn.apply(this,arguments);return new Promise(function(resolve,reject){function step(key,arg){try{var info=gen[key](arg);var value=info.value}catch(error){reject(error);return}if(info.done){resolve(value)}else{return Promise.resolve(value).then(function(value){step('next',value)},function(err){step('throw',err)})}}return step('next')})}}var top_list=[['\u4E91\u97F3\u4E50\u98D9\u5347\u699C',19723756],['\u4E91\u97F3\u4E50\u65B0\u6B4C\u699C',3779629],['\u7F51\u6613\u539F\u521B\u6B4C\u66F2\u699C',2884035],['\u4E91\u97F3\u4E50\u70ED\u6B4C\u699C',3778678],['\u4E91\u97F3\u4E50\u7535\u97F3\u699C',10520166],['UK\u6392\u884C\u699C\u5468\u699C',180106],['\u7F8E\u56FDBillboard\u5468\u699C',60198],['KTV\u55E8\u699C',21845217],['iTunes\u699C',11641012],['Hit FM Top\u699C',120001],['\u65E5\u672COricon\u5468\u699C',60131],['\u97E9\u56FDMelon\u6392\u884C\u699C\u5468\u699C',3733003],['\u97E9\u56FDMnet\u6392\u884C\u699C\u5468\u699C',60255],['\u97E9\u56FDMelon\u539F\u58F0\u5468\u699C',46772709],['\u4E2D\u56FDTOP\u6392\u884C\u699C(\u6E2F\u53F0\u699C)',112504],['\u4E2D\u56FDTOP\u6392\u884C\u699C(\u5185\u5730\u699C)',64016],['\u9999\u6E2F\u7535\u53F0\u4E2D\u6587\u6B4C\u66F2\u9F99\u864E\u699C',10169002],['\u534E\u8BED\u91D1\u66F2\u699C',4395559],['\u4E2D\u56FD\u563B\u54C8\u699C',1899724],['\u6CD5\u56FD NRJ EuroHot 30\u5468\u699C',27135204],['\u53F0\u6E7EHito\u6392\u884C\u699C',112463],['Beatport\u5168\u7403\u7535\u5B50\u821E\u66F2\u699C',3812895]];var getTopListNames=function getTopListNames(){return top_list.map(function(l,i){return' '+i+'. '+l[0]})};var requestTopSongList=function requestTopSongList(){var index=arguments.length>0&&arguments[0]!==undefined?arguments[0]:0;var option=(0,_util.deepCopy)(_config.globalOption);var url=_config.origin+'/discover/toplist?id='+top_list[index][1];var method='GET';Object.assign(option,{url:url,method:method});return(0,_requestPromiseNative2.default)(option).then(function(body){var re=new RegExp(/>\[.*\]</);return JSON.parse(body.match(re)[0].slice(1,-1))}).catch(function(e){return e})};var getTopSongList=function(){var _ref=_asyncToGenerator(regeneratorRuntime.mark(function _callee(){var index=arguments.length>0&&arguments[0]!==undefined?arguments[0]:0;return regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.next=2;return requestTopSongList(index);case 2:return _context.abrupt('return',_context.sent);case 3:case'end':return _context.stop();}}},_callee,undefined)}));return function getTopSongList(){return _ref.apply(this,arguments)}}();var song=function song(id){var option=(0,_util.deepCopy)(_config.globalOption);var url=_config.origin+'/api/song/detail?ids=%5B'+id+'%5d';var method='GET';Object.assign(option,{url:url,method:method});return(0,_requestPromiseNative2.default)(option).then(function(body){return JSON.parse(body).songs[0]}).catch(function(e){return e})};function str2ta(str){var buf=new ArrayBuffer(str.length);var bufView=new Uint8Array(buf);str.split('').map(function(s,i){bufView[i]=s.charCodeAt()});return bufView}var encodeId=function encodeId(dfsId){var a1=str2ta('3go8&$8*3*3h0k(2)2'),a2=str2ta(dfsId),a1l=a1.length;a2.map(function(c,i){a2[i]=c^a1[i%a1l]});var m=_crypto2.default.createHash('md5');m.update(a2);return m.digest().toString('base64').replace(/\//g,'_').replace(/\+/g,'-')};var getMp3Url=function getMp3Url(song){var music={};if(song.hasOwnProperty('hMusic')){music=song.hMusic}else if(song.hasOwnProperty('mMusic')){music=song.mMusic}else{console.log(song.hasOwnProperty('hMusic'));return song.mp3Url}var song_id=music.dfsId.toString();var enc_id=encodeId(song_id);return'http://m2.music.126.net/'+enc_id+'/'+song_id+'.mp3'};var search=function search(){var name=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;var type=arguments.length>1&&arguments[1]!==undefined?arguments[1]:1;var onlySong=arguments.length>2&&arguments[2]!==undefined?arguments[2]:true;var limit=arguments.length>3&&arguments[3]!==undefined?arguments[3]:3;var offset=arguments.length>4&&arguments[4]!==undefined?arguments[4]:0;var option=(0,_util.deepCopy)(_config.globalOption);var url=_config.origin+'/api/search/suggest/web';var form={s:name,type:type,limit:limit,offset:offset};var method='POST';Object.assign(option,{url:url,form:form,method:method});return(0,_requestPromiseNative2.default)(option).then(function(body){var info=JSON.parse(body);var data=void 0;if(onlySong){data=info.result.songs}else{data={songs:info.result.songs,mvs:info.result.mvs}}return data}).catch(function(e){return e})};var lrc=function lrc(id){var lv=arguments.length>1&&arguments[1]!==undefined?arguments[1]:-1;var option=(0,_util.deepCopy)(_config.globalOption);var url=_config.origin+'/api/song/lyric?lv='+lv+'&id='+id;var method='GET';Object.assign(option,{url:url,method:method});return(0,_requestPromiseNative2.default)(option).then(function(body){var l=JSON.parse(body);return l.hasOwnProperty('lrc')?l.lrc.lyric:'no lyric'}).catch(function(e){return e})};var playLists=function playLists(id){var option=(0,_util.deepCopy)(_config.globalOption);var url=_config.origin+'/api/playlist/detail?id='+id;var method='GET';Object.assign(option,{url:url,method:method});return(0,_requestPromiseNative2.default)(option).then(function(body){return JSON.parse(body).result}).catch(function(e){return e})};var artistAlbums=function artistAlbums(id){var limit=arguments.length>1&&arguments[1]!==undefined?arguments[1]:3;var offset=arguments.length>2&&arguments[2]!==undefined?arguments[2]:0;var option=(0,_util.deepCopy)(_config.globalOption);var url=_config.origin+'/api/artist/albums/'+id+'?offset='+offset+'&limit='+limit;var method='GET';Object.assign(option,{url:url,method:method});return(0,_requestPromiseNative2.default)(option).then(function(body){return JSON.parse(body)}).catch(function(e){return e})};var albums=function albums(id){var option=(0,_util.deepCopy)(_config.globalOption);var url=_config.origin+'/api/album/'+id;var method='GET';Object.assign(option,{url:url,method:method});return(0,_requestPromiseNative2.default)(option).then(function(body){return JSON.parse(body).album}).catch(function(e){return e})};exports.default={getTopListNames:getTopListNames,getTopSongList:getTopSongList,song:song,getMp3Url:getMp3Url,search:search,lrc:lrc,playLists:playLists,artistAlbums:artistAlbums,albums:albums};